<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz App</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <h1>Quiz App</h1>

    <div id="question-container">
      <p id="question-text"></p>
      <form id="quiz-form">
        <div id="choices-container"></div>
        <button type="submit">Submit</button>
      </form>
    </div>

    <p id="result-message"></p>

    <!-- âœ… ä¸­æ–­ãƒœã‚¿ãƒ³ -->
    <button
      id="exit-quiz"
      style="
        background-color: red;
        color: white;
        padding: 10px 20px;
        margin-top: 10px;
        font-size: 16px;
        border: none;
        cursor: pointer;
        display: block;
        width: fit-content;
      "
    >
      ğŸ›‘ å›ç­”ã‚’ä¸­æ–­ã—ã¦ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹
    </button>

    <!-- âœ… ä¸­æ–­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <p id="exit-message" style="color: red; display: none">
      âš ï¸ ãƒˆãƒƒãƒ—ã«æˆ»ã£ã¦ã‚‚å±¥æ­´ã¯ä¿å­˜ã•ã‚Œã¾ã™ã€‚
    </p>

    <script>
      let questions = JSON.parse("{{ quiz_questions_json|escapejs }}"); // Django ã‹ã‚‰å—ã‘å–ã£ãŸå•é¡ŒIDãƒªã‚¹ãƒˆ
      let currentQuestionIndex = 0;
      let showFeedback = "{{ show_feedback }}" === "yes";

      console.log("ğŸ› ï¸ DEBUG: åˆæœŸåŒ–æ™‚ã®å•é¡Œãƒªã‚¹ãƒˆ â†’", questions);
      console.log("ğŸ› ï¸ DEBUG: showFeedback â†’", showFeedback);

      function loadQuestion() {
        if (currentQuestionIndex >= questions.length) {
          alert("ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼å±¥æ­´ãƒšãƒ¼ã‚¸ã§çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          window.location.href = "/history/";
          return;
        }

        let questionId = questions[currentQuestionIndex];
        console.log(
          `ğŸ› ï¸ DEBUG: ç¾åœ¨ã®å•é¡ŒID â†’ ${questionId} (Index: ${currentQuestionIndex})`
        );

        $.getJSON(`/api/question_by_id/${questionId}/`, function (data) {
          console.log("ğŸ› ï¸ DEBUG: APIã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ â†’", data);

          $("#question-text").text(data.question_text);
          $("#choices-container").empty();

          let choices = data.choices;
          let correctAnswers = data.correct_answers
            ? data.correct_answers.map((ans) => ans.toUpperCase())
            : [];

          console.log("ğŸ› ï¸ DEBUG: æ­£è§£ã®é¸æŠè‚¢ â†’", correctAnswers);

          for (let key in choices) {
            $("#choices-container").append(
              `<label>
                  <input type="checkbox" name="answers" value="${key.toUpperCase()}"> 
                  <span class="choice-text" data-value="${key.toUpperCase()}">${key.toUpperCase()}. ${
                choices[key]
              }</span>
              </label><br>`
            );
          }

          $("#quiz-form").data("question-id", data.id);
          $("#quiz-form").data("correct-answers", correctAnswers); // âœ… æ­£è§£ã‚’ã‚»ãƒƒãƒˆ
          $("#result-message").text("");
        });
      }

      $("#quiz-form").submit(function (event) {
        event.preventDefault();

        let selectedAnswers = [];
        $("input[name='answers']:checked").each(function () {
          selectedAnswers.push($(this).val().toUpperCase());
        });

        let correctAnswers = $("#quiz-form").data("correct-answers"); // âœ… æ­£è§£ã®å–å¾—

        $.ajax({
          url: "/submit/",
          type: "POST",
          data: {
            question_id: $("#quiz-form").data("question-id"),
            answers: selectedAnswers,
            history_id: "{{ history_id }}",
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          traditional: true,
          success: function (response) {
            if (showFeedback) {
              // âœ… æ­£èª¤è¡¨ç¤ºã‚’é¸æŠå¯èƒ½ã«ã™ã‚‹
              if (response.is_correct) {
                $("#result-message").text("âœ… Correct!");
              } else {
                $("#result-message").text("âŒ Incorrect!");
              }

              // âœ… æ­£è§£ã®é¸æŠè‚¢ã‚’ç™½æŠœã + ç·‘èƒŒæ™¯ã«ã™ã‚‹
              $(".choice-text").each(function () {
                let choiceValue = $(this).data("value");
                if (correctAnswers.includes(choiceValue)) {
                  $(this).css({
                    color: "white",
                    "background-color": "green",
                    padding: "5px",
                    "border-radius": "5px",
                  });
                }
              });
            }
            currentQuestionIndex++;
            setTimeout(loadQuestion, 1000); // 1ç§’å¾Œã«æ¬¡ã®å•é¡Œ
          },
        });
      });

      // âœ… ã€Œå›ç­”ã‚’ä¸­æ–­ã—ã¦ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†
      $("#exit-quiz").click(function () {
        let confirmExit = confirm(
          "ãƒˆãƒƒãƒ—ã«æˆ»ã‚Šã¾ã™ã‹? â€»ãƒˆãƒƒãƒ—ã«æˆ»ã£ã¦ã‚‚å±¥æ­´ã¯ä¿å­˜ã•ã‚Œã¾ã™ã€‚"
        );

        if (confirmExit) {
          window.location.href = "/"; // ğŸ  ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
        }
      });

      $(document).ready(loadQuestion);
    </script>
  </body>
</html>
